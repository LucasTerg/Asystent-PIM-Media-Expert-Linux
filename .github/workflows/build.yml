name: Build for Steam Deck (Arch Linux)

on:
  push:
    tags:
      - 'v*' # Uruchamia się przy tagach np. v1.0.3
    branches: [ "main" ] # Uruchamia się też przy pushu na main (tworzy Artifact)
  workflow_dispatch:

permissions: 
  contents: write # Potrzebne do tworzenia Release

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install System Dependencies (Arch)
      run: |
        pacman -Sy --noconfirm
        pacman -S --noconfirm base-devel python python-pip tk git \
          libjpeg-turbo zlib libtiff libwebp openjpeg2 \
          libimagequant libraqm libxcb \
          cairo pkgconf gobject-introspection gtk3

    - name: Install Python Dependencies
      run: |
        python -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install tkinterdnd2 pyinstaller

    - name: Build with PyInstaller
      run: |
        source venv/bin/activate
        pyinstaller --noconfirm --onefile --windowed \
          --name "AsystentMediaExpert" \
          --add-data "realesrgan-ncnn-vulkan:." \
          --add-data "models:models" \
          --hidden-import "PIL._tkinter_finder" \
          --hidden-import "tkinterdnd2" \
          --collect-all "tkinterdnd2" \
          --collect-all "pillow_avif" \
          --collect-all "pillow_heif" \
          main.py

    # Artifact tworzony zawsze dla testów i brancha main
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: AsystentMediaExpert-Linux
        path: dist/AsystentMediaExpert

    # Release tworzony TYLKO gdy pushujemy tag
    - name: Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/AsystentMediaExpert
        # Opcjonalnie: automatyczne generowanie notatek
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}